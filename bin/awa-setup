#!/bin/bash

root=$( realpath "`dirname $BASH_SOURCE`/../" )
source "$root/bin/include.sh"
pushd "$root"
echo "awa path: $root"

venv_setting="`setting virtual_env`"
venv_default="$root/.env"
venv=${venv_setting:=$venv_default}

python -mvenv "$venv" --clear --symlinks
source "$venv/bin/activate"
pyver=`python -V | cut -d ' ' -f 2`
djver=`pip show django | grep Version | cut -d ' ' -f 2`
echo "virtual env: $venv (python $pyver, django $djver)"

echo -n "dependencies: "
echo -n "python "
pip install -qr requirements.txt

user_reqs="$root/config/requirements.txt"
if [[ -d "$user_reqs" ]]; then
    echo -n "python(user) "
    pip install -qr "$user_reqs"
fi

echo -n "node "
npm install
echo "complete!"

echo -n "maintenance: "
echo -n "database "
./manage.py migrate --noinput
echo -n "staticfiles "
./manage.py collectstatic --noinput
echo "complete!"
popd

# autoreload=`setting autoreload
# sleep 2
# echo "Attempting auto-reload..."
# touch mbme/wsgi.py  # auto-reloads

# #sudo systemctl restart apache2
# popd
